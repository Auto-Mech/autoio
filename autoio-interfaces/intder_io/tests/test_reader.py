""" test intder_io.reader
"""

import os
import numpy
from ioformat import pathtools
import intder_io.reader


PATH = os.path.dirname(os.path.realpath(__file__))
DAT_PATH = os.path.join(PATH, 'data')

OUT_STR = pathtools.read_file(DAT_PATH, 'output.dat')


def test__coords():
    """ test intder_io.reader.internal_coordinates
    """

    ref_intl_coords = (
        ('STRE', (1, 0)),
        ('STRE', (1, 2)),
        ('STRE', (2, 3)),
        ('STRE', (3, 4)),
        ('STRE', (0, 5)),
        ('STRE', (0, 6)),
        ('STRE', (0, 7)),
        ('STRE', (1, 8)),
        ('STRE', (4, 9)),
        ('STRE', (2, 10)),
        ('STRE', (2, 11)),
        ('BEND', (0, 1, 2)),
        ('BEND', (1, 2, 3)),
        ('BEND', (2, 3, 4)),
        ('BEND', (1, 0, 5)),
        ('BEND', (1, 0, 6)),
        ('BEND', (1, 0, 7)),
        ('BEND', (2, 1, 8)),
        ('BEND', (3, 4, 9)),
        ('BEND', (1, 2, 10)),
        ('BEND', (1, 2, 11)),
        ('TORS', (3, 2, 1, 0)),
        ('TORS', (4, 3, 2, 1)),
        ('TORS', (5, 0, 1, 2)),
        ('TORS', (6, 0, 1, 2)),
        ('TORS', (7, 0, 1, 2)),
        ('TORS', (8, 1, 2, 3)),
        ('TORS', (9, 4, 3, 2)),
        ('TORS', (10, 2, 1, 0)),
        ('TORS', (11, 2, 1, 0))
    )

    intl_coords = intder_io.reader.internal_coordinates(OUT_STR)
    assert ref_intl_coords == intl_coords


def test__ted_assignments():
    """ test intder_io.reader.ted_assignments
    """

    ref_ted = (
        (-1366.4, {8: 78.5, -4: 5.4, 1: 4.1, 26: 4.0}),
        (143.9, {21: 76.3, -24: 5.9, -14: 5.6, 24: 4.3}),
        (182.9, {22: 37.8, 24: 23.3, 23: 22.1, 25: 18.3}),
        (207.3, {22: 49.6, -25: 11.8, 21: 11.5, -27: 10.8}),
        (339.7, {2: 100.1}),
        (401.8, {11: 76.3, -24: 5.7, 20: 4.3}),
        (508.0, {12: 80.7, 26: 6.5, -15: -5.9, 21: 5.7}),
        (648.3, {13: 109.7, -4: -8.6, -14: -4.0}),
        (714.9, {28: 34.7, 29: 34.3, -28: 12.2, 16: 6.6}),
        (883.3, {19: 20.4, 0: 16.1, -22: 14.7, -28: 12.5}),
        (941.7, {28: 21.4, 15: 20.8, 26: 10.1, -16: 8.8}),
        (957.2, {0: 34.5, 28: 21.2, 14: 13.4, -31: 6.8}),
        (969.2, {29: 55.0, 0: 12.8, -30: 12.3, -29: 6.2}),
        (1089.3, {16: 35.2, -16: 18.0, 24: 12.5, 26: 10.3}),
        (1179.8, {15: 20.8, 0: 14.5, -21: 14.1, -13: 14.0}),
        (1263.8, {17: 43.8, -29: 29.4, 1: 14.0, 20: 9.3}),
        (1286.3, {27: 46.6, 26: 16.4, 1: 10.9, 20: 7.2}),
        (1322.8, {3: 77.7, -20: 10.0}),
        (1399.0, {14: 25.1, 16: 21.1, 15: 19.9, -21: 11.7}),
        (1430.2, {19: 24.9, -19: 13.3, 15: 13.0, 20: 9.5}),
        (1478.1, {24: 53.5, -27: 14.3, -25: 12.4, 14: 10.9}),
        (1492.4, {23: 38.8, -27: 35.4, -17: 11.6, 16: 4.1}),
        (1578.4, {1: 28.0, 18: 27.3, -22: 14.7, -21: 10.7}),
        (1603.6, {18: 60.0, -3: 16.9, 8: 7.5, 3: 7.3}),
        (3039.8, {6: 37.4, 5: 33.7, 4: 28.9}),
        (3117.5, {6: 43.0, -7: 34.1, -9: 21.0}),
        (3121.7, {4: 53.0, -9: 23.0, -8: 17.5, -7: 6.1}),
        (3134.3, {7: 53.5, -7: 26.4, 4: 16.5}),
        (3159.6, {10: 57.5, 9: 40.0}),
        (3258.7, {9: 57.7, -12: 41.9})
    )

    ted = intder_io.reader.ted_assignments(OUT_STR)

    for rmode, mode in zip(ref_ted, ted):
        assert numpy.isclose(rmode[0], mode[0])
        rdct, dct = rmode[1], mode[1]
        assert set(rdct.keys()) == set(dct.keys())
        assert numpy.allclose(tuple(rdct.values()), tuple(dct.values()))


if __name__ == '__main__':
    test__coords()
    test__ted_assignments()
